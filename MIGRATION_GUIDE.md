# üöÄ Upgrade Guide: Multi-User Authentication

This guide details the steps to transition your "Meus Rem√©dios" app from Pilot Mode to a full Multi-User System.

## 1. Supabase Dashboard Setup

### A. Enable Authentication
1. Go to your Supabase Dashboard > **Authentication** > **Providers**.
2. Ensure **Email / Password** is **Enabled**.
3. (Optional) Disable "Confirm Email" if you want instant login for testing (Authentication > Providers > Email > Confirm Email).

### B. Get Service Role Key
1. Go to **Project Settings** > **API**.
2. Find the **service_role** secret (starts with `ey...`).
3. **Copy this key**. You will need it for the next step.

---

## 2. Environment Variables

Update your `.env` file locally and in your deployment platform (Vercel/Render).

```env
# Add this new variable
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
```

**Why?** The Telegram Bot runs on the server and needs this "master key" to access user data directly, bypassing Row-Level Security.

---

## 3. Database Migration

Run the following SQL script in your **Supabase SQL Editor** to prepare the database.

```sql
-- 1. Add verification token column to user_settings (for Telegram linking)
ALTER TABLE public.user_settings 
ADD COLUMN IF NOT EXISTS verification_token text;

-- 2. Create the Data Migration Function
-- This function moves your existing pilot data (from ID 0000...1) to your new authenticated account.

CREATE OR REPLACE FUNCTION migrate_pilot_data()
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  current_user_id uuid;
  pilot_id uuid := '00000000-0000-0000-0000-000000000001';
BEGIN
  current_user_id := auth.uid();
  
  -- Prevent migration to pilot id (sanity check)
  IF current_user_id = pilot_id THEN
    RAISE EXCEPTION 'Cannot migrate to pilot ID';
  END IF;

  -- Update all tables
  UPDATE public.medicine_logs SET user_id = current_user_id WHERE user_id = pilot_id;
  UPDATE public.medicines SET user_id = current_user_id WHERE user_id = pilot_id;
  UPDATE public.notification_log SET user_id = current_user_id WHERE user_id = pilot_id;
  UPDATE public.protocols SET user_id = current_user_id WHERE user_id = pilot_id;
  UPDATE public.stock SET user_id = current_user_id WHERE user_id = pilot_id;
  UPDATE public.treatment_plans SET user_id = current_user_id WHERE user_id = pilot_id;
  -- bot_sessions might be tricky if chat_id duplicates, but update if possible
  UPDATE public.bot_sessions SET user_id = current_user_id WHERE user_id = pilot_id;
  
  -- Handle user_settings: If new user already has settings, valid; if not, migrate pilot settings
  IF EXISTS (SELECT 1 FROM public.user_settings WHERE user_id = pilot_id) THEN
    -- If current user has NO settings, take pilot's
    IF NOT EXISTS (SELECT 1 FROM public.user_settings WHERE user_id = current_user_id) THEN
       UPDATE public.user_settings SET user_id = current_user_id WHERE user_id = pilot_id;
    ELSE
       -- If current user HAS settings, merge/delete pilot's to avoid conflict
       -- For now, we prefer the pilot settings (has telegram_chat_id), so we might want to delete current and take pilot?
       -- Safer: Update pilot row to new ID, deleting the empty autogenerated row if exists
       DELETE FROM public.user_settings WHERE user_id = current_user_id;
       UPDATE public.user_settings SET user_id = current_user_id WHERE user_id = pilot_id;
    END IF;
  END IF;
  
END;
$$;
```

---

## 4. How to Migrate Your Data (Step-by-Step)

1. **Deploy** the code changes from this PR.
2. Open the App in your browser.
3. You will see the new **Login Screen**.
4. Click **"Criar Conta"** and register with your email.
5. Log in. You will see an empty dashboard (because you are a new user).
6. Click on your **Avatar/Name** in the top-right corner to open **Settings**.
7. Scroll down to **"Migra√ß√£o de Dados"**.
8. Click **"Migrar Dados Antigos"**.
9. ‚úÖ Your medicines, protocols, and history should appear immediately!

---

## 5. Re-link Telegram Bot

Since the authentication system changed, you need to re-link your Telegram Bot.

1. In **Settings**, go to **Integra√ß√£o Telegram**.
2. Click **"Gerar C√≥digo de V√≠nculo"**.
3. Send the command shown (e.g., `/start ABC1234`) to your bot.
4. The bot should confirm connection.

---

## 6. Security Cleanup (Final Step)

Once you have migrated and verified everything works, you should tighten the security policies to disable "Pilot Mode".

Run this SQL in Supabase:

```sql
-- Remove access for the Mock ID, allowing ONLY real authenticated users
DROP POLICY "Pilot_Select_medicines" ON public.medicines;
DROP POLICY "Pilot_Insert_medicines" ON public.medicines;
DROP POLICY "Pilot_Update_medicines" ON public.medicines;
DROP POLICY "Pilot_Delete_medicines" ON public.medicines;

-- (Repeat DROP/CREATE for all tables to remove the OR user_id = '000...01' clause)
-- Example specific strict policy:
CREATE POLICY "Strict_Select_medicines" ON public.medicines FOR SELECT TO authenticated USING (auth.uid() = user_id);
```
*(Note: You can do this step later, keeping Pilot Mode open is low risk if only you have the API keys, but strict RLS is best practice).*

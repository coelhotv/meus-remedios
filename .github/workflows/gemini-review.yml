name: Gemini Code Reviewer

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Number to review'
        required: true
        type: string
      skip_wait:
        description: 'Skip 5-minute wait'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  GEMINI_BOT_NAME: 'gemini-code-reviewer[bot]'
  NODE_VERSION: '20'
  WAIT_MINUTES: 5

jobs:
  # ==========================================
  # JOB 1: Preparar Contexto
  # ==========================================
  prepare:
    name: Prepare Context
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'issue_comment' && (startsWith(github.event.comment.body, '/gemini review') || contains(github.event.comment.body, '@gemini-code-assist'))) }}
    
    outputs:
      pr_number: ${{ steps.context.outputs.pr_number }}
      branch: ${{ steps.context.outputs.branch }}
      skip_wait: ${{ steps.context.outputs.skip_wait }}
    
    steps:
      - name: Fetch PR Data
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.eventName === 'workflow_dispatch' 
              ? context.payload.inputs.pr_number 
              : context.payload.issue.number.toString();
            
            const skipWait = context.eventName === 'workflow_dispatch'
              ? context.payload.inputs.skip_wait.toString()
              : 'false';

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt(prNumber)
            });

            core.setOutput('pr_number', prNumber);
            core.setOutput('branch', pr.head.ref);
            core.setOutput('skip_wait', skipWait);

      - name: Acknowledge
        if: ${{ github.event_name == 'issue_comment' }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt("${{ steps.context.outputs.pr_number }}"),
              body: `## ğŸ¤– Gemini Code Review Iniciado\n\nâ³ **Aguarde ${{ env.WAIT_MINUTES }} minutos** para anÃ¡lise completa...\n\nğŸ“‹ **O que serÃ¡ feito:**\n1. Gemini analisarÃ¡ seu cÃ³digo\n2. Identificarei issues de lint, formatting, lÃ³gica e arquitetura\n3. Aplicarei fixes automÃ¡ticos quando possÃ­vel\n4. Validarei com lint + testes\n5. Reportarei resumo no PR`
            });

  # ==========================================
  # JOB 2: Aguardar e Coletar ComentÃ¡rios
  # ==========================================
  fetch-comments:
    name: Fetch Gemini Comments
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Wait
        if: ${{ needs.prepare.outputs.skip_wait != 'true' }}
        run: sleep $(( ${{ env.WAIT_MINUTES }} * 60 ))
      
      - name: Fetch
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt("${{ needs.prepare.outputs.pr_number }}"),
              per_page: 100
            });
            
            const geminiComments = comments.filter(c => 
              c.user.type === 'Bot' && 
              (c.user.login.includes('gemini') || c.user.login.includes('google'))
            );
            
            require('fs').writeFileSync('gemini-comments.json', JSON.stringify(geminiComments, null, 2));

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: gemini-comments
          path: gemini-comments.json
          retention-days: 1

  # ==========================================
  # JOB 3: Auto-Fix
  # ==========================================
  fix:
    name: Apply Auto-Fixes
    runs-on: ubuntu-latest
    needs: [prepare, fetch-comments]
    outputs:
      changes: ${{ steps.check.outputs.count }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ needs.prepare.outputs.branch }}
          fetch-depth: 0
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install
        run: npm ci
      
      - name: Fix
        run: |
          npm run lint -- --fix || true
          npx prettier --write "src/**/*.{js,jsx,css,md}" || true
      
      - name: Check Changes
        id: check
        run: echo "count=$(git diff --name-only | wc -l)" >> $GITHUB_OUTPUT
      
      - name: Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "fix: auto-fix issues from Gemini Code Reviewer [skip ci]"
          branch: ${{ needs.prepare.outputs.branch }}

  # ==========================================
  # JOB 4: Validar
  # ==========================================
  validate:
    name: Validate Build
    runs-on: ubuntu-latest
    needs: [prepare, fix]
    outputs:
      lint: ${{ steps.check.outputs.lint }}
      smoke: ${{ steps.check.outputs.smoke }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.branch }}
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install
        run: npm ci
      - name: Run Checks
        id: check
        run: |
          if npm run lint; then echo "lint=passed" >> $GITHUB_OUTPUT; else echo "lint=failed" >> $GITHUB_OUTPUT; fi
          if npm run test:smoke; then echo "smoke=passed" >> $GITHUB_OUTPUT; else echo "smoke=failed" >> $GITHUB_OUTPUT; fi

  # ==========================================
  # JOB 5: Resumo
  # ==========================================
  summary:
    name: Post Summary
    runs-on: ubuntu-latest
    needs: [prepare, fix, validate]
    if: ${{ always() }}
    steps:
      - name: Post
        uses: actions/github-script@v7
        with:
          script: |
            const changes = "${{ needs.fix.outputs.changes }}" || "0";
            const lint = "${{ needs.validate.outputs.lint }}" || "unknown";
            const smoke = "${{ needs.validate.outputs.smoke }}" || "unknown";
            const prNumber = parseInt("${{ needs.prepare.outputs.pr_number }}");
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ğŸ¤– Gemini Code Review - Resumo\n\n### âœ… Auto-Fixes Aplicados\n- Arquivos modificados: ${changes}\n\n### ğŸ“Š ValidaÃ§Ã£o PÃ³s-Fix\n- **Lint:** ${lint === 'passed' ? 'âœ… Passou' : 'âŒ Falhou'}\n- **Smoke Tests:** ${smoke === 'passed' ? 'âœ… Passou' : 'âŒ Falhou'}\n\nğŸ’¬ Novos commits ou a menÃ§Ã£o \`@gemini-code-assist\` reiniciarÃ£o esta anÃ¡lise.`
            });

name: PR Auto-Trigger Gemini Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '20'
  WAIT_MINUTES: 5

jobs:
  post-initial-comment:
    name: Post Initial Comment
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.user.type != 'Bot' }}
    steps:
      - name: Post Command
        uses: actions/github-script@v7
        with:
          script: |
            const prAuthor = context.payload.pull_request.user.login;
            const action = context.payload.action;
            const body = (action === 'opened' || action === 'reopened')
              ? `## ğŸ¤– Gemini Code Review\n\nOlÃ¡ @${prAuthor}! Vou iniciar a revisÃ£o do seu PR.\n\nğŸ” **Comando enviado:** \`/gemini review\`\n\nâ³ Aguarde **5 minutos** para o processamento.`
              : `## ğŸ”„ AtualizaÃ§Ã£o detectada\n\n@${prAuthor}, novos commits enviados. Reiniciando revisÃ£o automÃ¡tica...\n\nğŸ” **Comando enviado:** \`/gemini review\``;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });

  wait-analysis:
    name: Wait for Analysis
    runs-on: ubuntu-latest
    needs: post-initial-comment
    steps:
      - name: Wait
        run: sleep $(( ${{ env.WAIT_MINUTES }} * 60 ))

  validate-pr:
    name: Validate PR
    runs-on: ubuntu-latest
    needs: wait-analysis
    outputs:
      status: ${{ steps.lint-result.outputs.status }}
      smoke_status: ${{ steps.smoke-result.outputs.smoke_status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install
        run: npm ci
      - name: Run Lint
        id: lint-result
        run: |
          if npm run lint; then echo "status=passed" >> $GITHUB_OUTPUT; else echo "status=failed" >> $GITHUB_OUTPUT; fi
      - name: Run Smoke
        id: smoke-result
        run: |
          if npm run test:smoke; then echo "smoke_status=passed" >> $GITHUB_OUTPUT; else echo "smoke_status=failed" >> $GITHUB_OUTPUT; fi

  post-summary:
    name: Post Summary
    runs-on: ubuntu-latest
    needs: validate-pr
    if: ${{ always() }}
    steps:
      - name: Post Summary Comment
        uses: actions/github-script@v7
        with:
          script: |
            const lintStatus = "${{ needs.validate-pr.outputs.status }}" || "unknown";
            const smokeStatus = "${{ needs.validate-pr.outputs.smoke_status }}" || "unknown";
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ğŸ¤– Gemini Code Review - ConcluÃ­do\n\n### âœ… ValidaÃ§Ã£o\n\n- **Lint:** ${lintStatus === 'passed' ? 'âœ… Passou' : 'âŒ Falhou'}\n- **Smoke Tests:** ${smokeStatus === 'passed' ? 'âœ… Passou' : 'âš ï¸ Falhou'}\n\n### ğŸ“‹ PrÃ³ximos Passos\n\n1. âœ… Se todos passaram, o PR estÃ¡ pronto para merge\n2. âš ï¸ Se hÃ¡ falhas, resolva-as antes de prosseguir\n3. ğŸ’¬ Use \`/gemini review\` para re-rodar`
            });
